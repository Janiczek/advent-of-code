module Year2017.Day1X exposing (..)

import Advent exposing (Test)
import Array.Hamt as Array exposing (Array)


main : Program Never ( Output1, Output2 ) Never
main =
    Advent.program
        { input = input
        , parse1 = parse
        , parse2 = parse
        , compute1 = compute1
        , compute2 = compute2
        , tests1 = tests1
        , tests2 = tests2
        }


type alias Input =
    Array (Array Char)


type alias Output1 =
    String


type alias Output2 =
    Int


parse : String -> Input
parse input =
    input
        |> String.lines
        |> List.map String.toList
        |> List.map Array.fromList
        |> Array.fromList


compute : Input -> ( String, Int )
compute input =
    let
        indexOfStart =
            input
                -- first row
                |> Array.get 0
                |> Advent.unsafeMaybe
                |> Array.indexedMap (,)
                |> Array.filter (\( _, ch ) -> ch /= ' ')
                |> Array.toList
                |> List.head
                |> Maybe.map Tuple.first
                |> Advent.unsafeMaybe
    in
        go ( indexOfStart, 0 ) [] StayOnCourse Down input 1


compute1 : Input -> Output1
compute1 input =
    compute input
        |> Tuple.first


go : ( Int, Int ) -> List Char -> Action -> Direction -> Input -> Int -> ( String, Int )
go ( x, y ) savedChars action direction grid steps =
    let
        ( newX, newY ) =
            nextPosition direction ( x, y )

        nextChar : Maybe Char
        nextChar =
            get ( newX, newY ) grid

        nextAction =
            nextChar
                |> Maybe.map toAction
                |> Maybe.withDefault None
    in
        case nextAction of
            StayOnCourse ->
                go ( newX, newY ) savedChars action direction grid (steps + 1)

            Change ->
                let
                    newDirection =
                        findNewDirection ( newX, newY ) direction grid
                in
                    -- potential bug?
                    go ( newX, newY ) savedChars action newDirection grid (steps + 1)

            None ->
                ( String.fromList savedChars, steps )

            Letter c ->
                go
                    ( newX, newY )
                    (newSavedChars c savedChars)
                    action
                    direction
                    grid
                    (steps + 1)


findNewDirection : ( Int, Int ) -> Direction -> Input -> Direction
findNewDirection ( x, y ) direction grid =
    let
        leftRight =
            let
                char =
                    get ( x - 1, y ) grid
            in
                if char /= Nothing && char /= Just ' ' then
                    Left
                else
                    Right

        upDown =
            let
                char =
                    get ( x, y - 1 ) grid
            in
                if char /= Nothing && char /= Just ' ' then
                    Up
                else
                    Down
    in
        case direction of
            Up ->
                leftRight

            Down ->
                leftRight

            Left ->
                upDown

            Right ->
                upDown


newSavedChars : Char -> List Char -> List Char
newSavedChars c chars =
    chars ++ [ c ]


nextPosition : Direction -> ( Int, Int ) -> ( Int, Int )
nextPosition direction ( x, y ) =
    case direction of
        Left ->
            ( x - 1, y )

        Right ->
            ( x + 1, y )

        Up ->
            ( x, y - 1 )

        Down ->
            ( x, y + 1 )


type Action
    = StayOnCourse
    | Change
    | None
    | Letter Char


type Direction
    = Left
    | Right
    | Up
    | Down


toAction : Char -> Action
toAction char =
    case char of
        '|' ->
            StayOnCourse

        '-' ->
            StayOnCourse

        '+' ->
            Change

        ' ' ->
            None

        c ->
            Letter c


get : ( Int, Int ) -> Input -> Maybe Char
get ( x, y ) grid =
    grid
        |> Array.get y
        |> Advent.unsafeMaybe
        |> Array.get x


compute2 : Input -> Output2
compute2 input =
    compute input
        |> Tuple.second


tests1 : List (Test Input Output1)
tests1 =
    []


tests2 : List (Test Input Output2)
tests2 =
    []


input : String
input =
    {-
           """     |
            |  +--+
            A  |  C
        F---|----E|--+
            |  |  |  D
            +B-+  +--+
       """
    -}
    """                                          |
    +-----+         +-----+ +-----+ +-----|-----+   +-+           +-----------------------------------------------------------------------------------------+ +---------+       +-+               +-+
    |     |         |     | |     | |     |     |   | |           |                                                                                         | |         |       | |               | |
    |     | +-------+ +---+ |     +-------------|---+ +---------------------+ +-----------------------------------------------------------------------------|-----------|---------------+         +-|---+
    |     | |         |     |       |     |     |                 |         | |                                                                             | |         |       | |     |           |   |
    |   +---|-------+ +-----|---+ +-------------|---+             |         | |                                           +-----Q                   +-------|-|-----+   |     +-|-|-------+         |   |
    |   | | |       |       |   | | |     |     |   |             |         | |                                           |                         |       | |     |   |     | | |     | |         |   |
    |   | | |       |   +---------|-|-----------|-------+         |         +-----------------------------+               +-----+                   |       | |     +-----+   | | |     | |         |   |
    |   | | |       |   |   |   | | |     |     |   |   |         |           |                           |                     |                   |       | |         | |   | | |     | |         |   |
    |   | | |       |   |   |   | +-+ +---------|---+   |       +-+ +-----------------------------------------------------------|-------------------|-------|-----------|-----+ | |     | | +-------|-----+
    |   | | |       |   |   |   |     |   |     |       |       |   |         |                           |                     |                   |       | |         | |     | |     | | |       |   | |
    |   | | |       |   +---|---|-+   |   |     |       |       |   |         |                 +---------------------------------+                 |     +-------------|-|-------------+ | |       | +-+ |
    |   | | |       |       |   | |   |   |     |       |       |   |         |                 |         |                     | |                 |     | | |         | |     | |       | |       | |   |
    |   +---+       |       |   | +---|-------------+   |       |   |         |           +-----|---------|---------------------|-|-----------------|-----|-|---+   +-------------|-----------------|-|-+ |
    |     |         |       |   |     |   |     |   |   |       |   |         |           |     |         |                     | |                 |     | | | |   |   | |     | |       | |       | | | |
    |     |         |       |   +---------|-------+ |   |       | +-----------------------------|-------------------------------|-+                 |     | +---+   |   | +---+ | | +---------------|-|-+ |
    |     |         |       |         |   |     | | |   |       | | |         |           |     |         |                     |                   |     |   |     |   |     | | | |     | |       | |   |
    |     |         |       |         |   |     | | |   |       | +-----------------------|-+   |     +-------------------------|-------------------------|---|---------|-----+ | | |     | |       | |   |
    |     |         |       |         |   |     | | |   |       |   |         |           | |   |     |   |                     |                   |     |   |     |   |       | | |     | |       | |   |
    |     |     +-----------|-------------|-----|-|-------------|---+         |           | +---|-----------------------+       +-------------+     |     |   |     |   |       | | |     | |       | | +-+
    |     |     |   |       |         |   |     | | |   |       |             |           |     |     |   |             |                     |     |     |   |     |   |       | | |     | |       | | |
    |     |     |   |       |   +---------|-----|-|-+   |       +-------------------------------|---------------------------------------------------|-------------------|---------|-|-------+       | | |
    |     |     |   |       |   |     |   |     | |     |                     |           |     |     |   |             |                     |     |     |   |     |   |       | | |     |         | | |
    |     |     +---+   +-------|---------------+ | +---|---------------------------------|-----|-+   |   |             |                     | +---|-----+   |     |   |       | | |     |         | | |
    |     |             |   |   |     |   |       | |   |                     |           |     | |   |   |             |                     | |   |         |     |   |       | | |     |         | | |
    |     |       +-----+   |   | +-------|-------|---+ | +-------------------|-----------|-----|-|---|---------------------------------------|-|-------------------|---|-------|-|-----------------+ | |
    |     |       |         |   | |   |   |       | | | | |                   |           |     | |   |   |             |                     | |   |         |     |   |       | | |     |           | |
    | +-------------------------|---------|-----------|-----------------------------------|-----|-|---|---|-------------------------------------+   |         |     |   |       | | |     |           | |
    | |   |       |         |   | |   |   |       | | | | |                   |           |     | |   |   |             |                     |     |         |     |   |       | | |     |           | |
    | |   |       +-+   +-------|---------------+ | | | | |                   |           |     | |   +-+ |             |             +-----------------------|-----------------|---------|-+         | |
    | |   |         |   |   |   | |   |   |     | | | | | |                   |           |     | |     | |             |             |       |     |         |     |   |       | | |     | |         | |
    | +---|-+     +-+   |   |   | | +-|-----+   | | +-|-+ |                   |           |     | |     | |             |             |       |     |         |     |   |       | | |     | |         | |
    |     | |     |     |   |   | | | |   | |   | |   |   |                   |           |     | |     | |             |             |       |     |         |     |   |       | | |     | |         | |
    |     | |     +-----|-------|-----|---|-|---|-|---------------------------------------------|-|-----------------------------------|-------|-------------------------+       | | |     +-+         | |
    |     | |           |   |   | | | |   | |   | |   |   |                   |           |     | |     | |             |             |       |     G         |     |           | | |                 | |
    |     | |     +-----|-+ | +-|-|---------|---|-----|---|-------------------------------|-------------|-|-----+       |     +---------------------|-----------------------------|-|-----------------+ |
    |     | |     |     | | | | | | | |   | |   | |   |   |                   |           |     | |     | |     |       |     |       |       |     |         |     |           | | |                   |
    |     | |     | +-----|-|-|-----|-|---------------|-----------------------------------------|-------|---------------------|---------------------|---------|---------------+ | | |                   |
    |     | |     | |   | | | | | | | |   | |   | |   |   |                   |           |     | |     | |     |       |     |       |       |     |         |     |         | | | |                   |
    | +-------------------|-----|-|---------+   | |   |   | +-----------------------------|-----|-|-----|---------------------|---------------|---------------|-----|---------|-|-|-|-----+             |
    | |   | |     | |   | | | | | | | |   |     | |   |   | |                 |           |     | |     | |     |       |     |       |       |     |         |     |         | | | |     |             |
    | |   | |     | |   | | +---+ | +---------------------|-|---------------+ |           |     | |     | |     |       +-----|---------+     |     |       +-|-----|-----+   | | | |     |             |
    | |   | |     | |   | |   |   |   |   |     | |   |   | |               | |           |     | |     | |     |             |       | |     |     |       | |     |     |   | | | |     |             |
    | |   | |     | |   | |   |   |   |   |     | |   |   | |               | |           | +---|-|-------|-----|-------------|-------|-------------+   +-+ | +-----|---------+ | | |     |             |
    | |   | |     | |   | |   |   |   |   |     | |   |   | |               | |           | |   | |     | |     |             |       | |     |         | | |       |     |     | | |     |             |
    | |   | |     | |   | |   |   |   | +-------|---------|-|---------------|-------------+ |   | |     | |     |     +-------|-------------+ +---------+ | |       |     |     +-------+ |             |
    | |   | |     | |   | |   |   |   | | |     | |   |   | |               | |             |   | |     | |     |     |       |       | |   |             | |       |     |       | |   | |             |
    | |   | |     | |   | |   |   |   | | |     | |   |   | |               | |             |   | |     | |     |     |       |     +-----------------------|-------|-----+       | |   | |             |
    | |   | |     | |   | |   |   |   | | |     | |   |   | |               | |             |   | |     | |     |     |       |     | | |   |             | |       |             | |   | |             |
    | |   | |     | |   | |   |   | +---+ |     | |   |   | |               | | +-----------|-----------|-----+ |     |       |     +---|---|-------------|-|------------------P----|-+ | |             |
    | |   | |     | |   | |   |   | | |   |     | |   |   | |               | | |           |   | |     | |   | |     |       |       | |   |             | |       |             | | | | |             |
    | |   | |     | |   | |   |   | | |   |     | |   |   | |               | | |           |   | |     | |   | |     |     +-+       | |   | +---+       | |       |             | | | | |             |
    | |   | |     | |   | |   |   | | |   |     | |   |   | |               | | |           |   | |     | |   | |     |     |         | |   | |   |       | |       |             | | | | |             |
    | |   | |     | |   | | +-------------------|-|-----------------------+ | | |           |   | |     | |   | |     |     |         | |   | |   |       | |       |             | | | | |             |
    | |   | |     | |   | | | |   | | |   |     | |   |   | |             | | | |           |   | |     | |   | |     |     |         | |   | |   |       | |       |             | | | | |             |
    | | +---|-----|-------|-|-|-----|-+   |     | |   | +---|-------------------------------|---+ |     | |   | |     |     |         | |   | |   |       | | +---------------------|-----|---+         |
    | | | | |     | |   | | | |   | |     |     | |   | | | |             | | | |           |     |     | |   | |     |     |         | |   | |   |       | | |     |             | | | | |   |         |
    | | | | |     | +-------------|-|-----------|-|-----|-----------------|---|-|-----------|-----------|-+   | |     |     |         | +---|-----|-----------------------+       | | | | |   |         |
    | | | | |     |     | | | |   | |     |     | |   | | | |             | | | |           |     |     |     | |     |     |         |     | |   |       | | |     |     |       | | | | |   |         |
    | | | | |     |     | | | |   | |     |     | |   | | | |             | | | |           |     |     |     | |     |     |         |     | |   |       | | |     |     |       | | | | |   |         |
    | | | | |     |     | | | |   | |     |     | |   | | | |             | | | |           |     |     |     | |     |     |         |     | |   |       | | |     |     |       | | | | |   |         |
    | | | | |     |     | | | |   | |     |     | +---+ | | |             | | | |           |     |     |     | |     |     |         |     | | +-|-------|-|-|-----|-------------|-----+ |   | +---+   |
    | | | | |     |     | | | |   | |     |     |       | | |             | | | |           |     |     |     | |     |     |         |     | | | |       | | |     |     |       | | |   |   | |   |   |
    | | | | |     |     | | | |   | |     |     |       | | |       +-----|-|---|-----------|-----|-------+   | |     |     |         |     | | | |       | | |     |     |       | | |   |   | |   |   |
    | | | | |     |     | | | |   | |     |     |       | | |       |     | | | |           |     |     | |   | |     |     |         |     | | | |       | | |     |     |       | | |   |   | |   |   |
    | | | | |     |     | | | |   | |     |     |       | | |       |     | | | |       +-+ |     |   +-|-+   | |     |     |         |     | | | |       | | |     |     |   +---|---|---|---|-|---|-+ |
    | | | | |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |       | | |     |     |   |   | | |   |   | |   | | |
    | | | | |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |       | | |     |     |   |   | | |   |   | |   | | |
    | | | | |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |       | | |     |     |   |   | | |   |   | |   | | R
    | | | +-------|-----|-|-|-|-----|-----|---------------|-----------------|-|-------------------|---|---------|-----------|-------------------|-----+   | | |     |     |   |   | | |   |   | |   | | |
    | | |   |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   |   | | |     |     |   |   | | |   |   | |   | | |
    | | |   |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   |   | | |     |     |   |   | | |   | +---|---|---|-+
    | | |   |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   |   | | |     |     |   |   | | |   | | | |   | | | |
    | | |   |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   |   | | |     |     |   |   | | |   | | | |   | | | |
    | | |   |     |     | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   |   | | |     |     |   |   | | |   | | | |   | | | |
    | | +-----------+   | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   | +-----------|---------+   | | |   | | | |   | | | |
    | |     |     | |   | | | |   | |     |     |       | | |       |     | | | |       | | |     |   | |     | |     |     |         |     | | | |   | | | | |     |     |       | | |   | | | |   | | | |
    | |     |     | |   | | | |   | |     |   +-|---------|-|---------------|-----------|---+     |   | |     | |     |     |         |     | | | |   | | | | |     |     |       | | |   | | | |   | | | |
    | |     |     | |   | | | |   | |     |   | |       | | |       |     | | | |       | |       |   | |     | |     |     |         |     | | | |   | | | | |     |     |       | | |   | | | |   | | | |
    | |     |     | | +-|-----|-----|---------|-----------|---------------|-|-----------|---------------+ +---|-----------------------|-----|-|-|-|-----|-----|---+ |     |       | | |   | | | |   | | | |
    | |     |     | | | | | | |   | |     |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   | | | | |   | |     |       | | |   | | | |   | | | |
    | |     |     | | | | | | | +-|-----+ |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   | | | | |   | |     |       | | |   | | | |   | | | |
    | |     |     | | | | | | | | | |   | |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   | | | | |   | |     |       | | |   | | | |   | | | |
    | |     |     | | | | | | | | | |   | |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   | +---|-|-----+     |       | | |   | | | |   | | | |
    | |     |     | | | | | | | | | |   | |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   |   | | |   |       |       | | |   | | | |   | | | |
    | |     |     | | | | | | | | | |   | |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   |   | | |   |       |       | | |   | | | |   | | | |
    | |     |     | | | | | | | | | |   | |   | |       | | |       |     | | | |       | |       |   |   |   | |     |     |         |     | | | |   |   | | |   |       |       | | |   | | | |   | | | |
    | |     |     | | | | | | | | +-------|---|---------|---|-------|-----|-|-|-------------------|---|-------+ |     |     |         |     | | | |   |   | | |   |       |     +-|-------|-|---|-+ | | | |
    | |     |     | | | | | | | |   |   | |   | |       | | |       |     | | | |       | |       |   |   |     |     |     |         |     | | | |   |   | | |   |       |     | | | |   | | | | | | | | |
    | |     |     | | | | | | | |   | +-|-|---+ |       | | |       |     | | | |       | |       |   |   |     |     |     |         |     | | | |   |   | | |   |       |     +-|-|---+ | | | | | | | | |
    | |     |     | | | | | | | |   | | | |     |       | | |       |     | | | |       | |       |   |   |     |     |     |         |     | | | |   |   | | |   |       |       | | | | | | | | | | | | |
    | | +---|-----|-|-----|-|-----------|---------------+ | |       |     | | | |       | |       |   |   |     +-----------|-----------------|-|-|---|---|-|-----------+ |       | | | | | | | | | | | | |
    | | |   |     | | | | | | | |   | | | |     |         | |       |     | | | |       | |       |   E   |           |     |         |     | | | |   |   | | |   |     | |       | | | | | | | | | | | | |
    | | |   |     | | | | | | | |   | | +-|-----|---------|-|-------------|-|-------------|-------|---|-------+       |     | +-------|-+   | | | |   |   | | |   | +---|-|-----+ | | | | | | | | | | | | |
    | | |   |     | | | | | | | |   | |   |     |         | |       |     | | | |       | |       |   |   |   |       |     | |       | |   | | | |   |   | | |   | |   | |     | | | | | | | | | | | | | |
    | | |   |     | | | | | | | |   | |   |     |         | |       |     | | | |       | |       |   |   |   |       |     | |       | |   | | | |   |   | | |   | |   | |     | | | | | | | | | | | | | |
    | | |   |     | | | | | | | |   | |   |     |         | |       |     | | | |       | |       |   |   |   |       |     | |       | |   | | | |   |   | | |   | |   | |     | | | | | | | | | | | | | |
    | | |   |     | | | | | | | |   | |   +---------------|-|-------|---+ | | | |       | |       |   |   |   |       |     | |       | | +---|-|-|---|-----|-|-----|---|-----------------|-|-|-|-|-|-+ | |
    | | |   |     | | | | | | | |   | |         |         | |       |   | | | | |       | |       |   |   |   |       |     | |       | | | | | | |   |   | | |   | |   | |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |   +-|---------|---------|-|-------|---|-|---------------|-------|---|---------------|-----+ |       | | | | | | |   |   | | |   +-|-+ | |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |     |         |         | |       |   | | | | |       | |       |   |   |   |       |       |       | | | | | | |   |   | | |     | | | |     | | | | | | | | | | |   | |
    | | |   | +---|-|-|---------------+ +-------|-+       | |       |   | | | | |       | | +-----|---|---------------|-----+ |       | | | | | | |   +---------+   | | | |     | | | | | | | | | | |   | |
    | | |   | |   | | | | | | | |       |       | |       | |       |   | | | | |       | | |     |   |   |   |       |     | |       | | | | | | |       | | | |   | | | |     | | | | | | | | | | |   | |
    | | |   | |   | | | | | | | |       |       | |       | |       |   | | | | |       | | |     |   |   |   |       |     | |       | | | | | | |     +---|---|-+ | | | |     | | | | | | | | | | |   | |
    | | |   | |   | | | | | | | |       |       | |       | |       |   | | | | |       | | |     |   |   |   |       |     | |       | | | | | | |     | | | | | | | | | |     | | | | | | | | | | |   | |
    | | |   | |   | | | | | | | |       |       | |       | |       | +---|---------------|-----------|---|-------------------|-------|-|-|-------------|---|-+ | | | | | |     | | | | | | | | | | |   | |
    | | |   | |   | | | | | | | |       |       | |       | |       | | | | | | |       | | |     |   |   |   |       |     | |       | | | | | | |     | | |   | | | | | |     | | | | | | | | | | |   | |
    | | | +-|-|---|-|-|-|-|-----|-----------------|---------|-------|---|-|---|---------|---------|---|---+   |       |     | |       | | | | | | |     | | |   | | | | | |     | | | | | | | | | | |   | |
    | | | | | |   | | | | | | | |       |       | |       | |       | | | | | | |       | | |     |   |       |       |     | |       | | | | | | |     | | |   | | | | | |     | | | | | | | | | | |   | |
    | | | +---+   | | | | | | | |       |       | |       | +-------|---|-|-------------|---|-------------------------|-----|-|-------|-|---|-|---|-------|---------|---+ |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | | | | | | |       | | |     |   |       |       |     | |       | | | | | | |     | | |   | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | | | | | | |       | | |     |   |       |       |     | |       +-|-|-|-----|----V|-|---+ | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | | | | | | |       | | |     |   |       |       |     | |         | | | | | |     | | | | | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | | | | | | |       | | |     |   |       |       |     | |         | | | | | |     | | | | | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | | | | | | |       | | |     |   |       |       |     | |         | | | | | |     | | | | | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | | +-|---|---------|-----+   |   |       |       |     | |         | | | | | |     | | | | | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | |   | | | |       | | | |   |   |       |       |     | |         | | | | | |     | | | | | | | |   |     | | | | | | | | | | |   | |
    | | |   |     | | | | | | | |       |       | |       |         | |   | +-|-|-------------|---|-----------|-----------------------------|-|-------+ | +-|---|-+ | |   |     | | +---|-|-------|---+ | |
    | | |   |     | | | | | | | |       |       | |       |         | |   |   | |       | | | |   |   |       |       |     | |         | | | | | |   | |   | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       |         | |   |   | |       | | | |   |   |       |       |     | |         | | | | | |   | |   | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       |         | |   |   | |       | | | |   |   |       |       |     | |         | | | | | |   | |   | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       | +-------|-|---|---|-|-------|---|---------|-------|-------|-----------------|---------|---|-+   | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       | |       | |   |   | |       | | | |   |   |       |       |     | |         | | | | | |   |     | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       | |       | |   | +---|-----------|---------+       |       |     | |         | | | | | |   |     | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       | |       | |   | | | |       | | | |   |           |       |     | |         | | | | | |   |     | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       | |       | |   | | | |       | | | |   |           |       |     | |         | | | | | |   |     | | |   | |   |     | |   | | | | | | | | | | |
    | | |   |     | | | | | | | |       |       | |       | |       | |   | | | |       | | | |   |           |       |     | |         | | | | | |   |     | | |   | |   |     | |   | | | | | | | | | | |
    | +-------------------|-|-|-----------------|-|-------|-|-------|-|---|-|-|---------|---------|-----------|-------|-----------------|-|-|-----------------|-|---|-----------|-|-----|---|---|-|-+ | | |
    |   |   |     | | | | | | | |       |       | |       | |       | |   | | | |       | | | |   |           |       |     | |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |     | | | | | | | |   +-----------|---------+ |       | |   | | | +-----------|-|---------------|-------|-----+ |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |     | | | | | | | |   |   |       | |         |       | |   | | |         | | | |   |           |       |       |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |   +-------|-|-+ | |   | +-+       | |         |       | |   | | |         | | | |   |           |       |       |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |   | | | | | |   | |   | |         | |         |       | |   | | |         | | | |   |           |       |       |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |   | | | | | |   | |   | |         | |         |       | |   | | |         | | | |   |           |       |       |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |   | | | | | |   | |   | |         | |         |       | |   | | |         | | | |   |           |       |       |         | | | | | |   |     | | |   | |   |     | |   | | | | | | |   | | |
    |   |   |   | | | | | |   | |   | |         | |         |       | |   | | |         | | | |   |           |   +---|-+     |         | +-|-|---|---|---------------|---------------|-----+ | | |   | | |
    |   |   |   | | | | | |   | |   | |         | |         |       | |   | | |         | | | |   |           |   |   | |     |         |   | | | |   |     | | |   | |   |     | |   | | |   | | |   | | |
    |   |   |   | | | | | |   | |   | |         | |       +---------|-|---|---|---------------|---|---------------|---|-+     |         |   | | | |   |     | +-|---|-|-----------|---|-|-----------+ | | |
    |   |   |   | | | | | |   | |   | |         | |       | |       | |   | | |         | | | |   |           |   |   |       |         |   | | | |   |     |   |   | |   |     | |   | | |   | | | | | | |
    +---------------------|-----|-----------------|-------|-|---------|-------|-----------|-|-|---|-----------|A--|-------------------------|-|-|-|---------|-------|-----|-----|-----|---+   | | +-|-----+
        |   |   | | | | | |   | |   | |         | |       | |       | |   | | |         | | | |   |           |   |   |       |         |   | | | |   |     |   |   | |   |     | |   | |     | |   | | |
    +---|----M--|-|---|---|---|-------|---------|-----------|-------|-----+ | |         | | | |   |           |   |   |       |         |   | | | +---|---------------|---------|-|---|-|-----|-----+ | |
    |   |   |   | | | | | |   | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |   | |     | |     | |
    +---+   | +-|-|-|-|-|-|-----------|-----------|-------|-|---------------|-----------|-----|---|-----------|---|---|-------|---------|---|---------------|---|---|-----|-----|-----|-|-----|-|-------|-+
            | | | | | | | |   | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |   | |     | |     | | |
            | | | | | | | |   | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |   | |     | |   +-+ | |
            | | | | | | | |   | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |   | |     | |   |   | |
            | | | | | | | |   | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |   | |     | |   |   | |
            | | | | | | | |   | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |   | |     | |   |   | |
            | | | | | | | +-----|-----------------|-----------------|-------------------|-|-|-|---------------|---------------------------------------|---------|-----|-----------|---+ |     | |   |   | |
            | | | | | | |     | |   | |         | |       | |       | |     | |         | | | |   |           |   |   |       |         |   | | |     |     |   |   | |   |     | |     |     | |   |   | |
            | | | | | | |     | |   +-|---------|---------|---------------------------------|-----|-------------------------------------+ +---|-|-----+   +-|---|---------|-----|---------------|---+   | |
            | | | | | | |     | |     |         | |       | |       | |     | |         | | | |   |           |   |   |       |           | | | |         | |   |   | |   |     | |     |     | |       | |
            | | | | | | |     | |     |         | |       | |       | |     | |         | | | |   |           |   |   |       |           | | | |         | |   |   | |   |     | |     |     | |       | |
            | | | | | | |     | |     |         | |       | |       | |     | |         | | | |   |           |   |   |       |           | | | |         | |   |   | |   |     | |     |     | |       | |
            | | | | | +-|-----|-------+         | |       | +-------|---------|-----------|-----------------------|-----------------------------|---------|-----|---|-|---------|-|-----|---------------|-+
            | | | | |   |     | |               | |       |         | |     | |         | | | |   |           |   |   |       |           | | | |         | |   |   | |   |     | |     |     | |       |
            | | | | |   |     | |               | |       |         | |   +-+ |         | | | |   |           |   |   |       |           | | | |         | |   |   | |   |     | |     |     | |       |
            | | | | |   |     | |               | |       |         | |   |   |         | | | |   |           |   |   |       |           | | | |         | |   |   | |   |     | |     |     | |       |
            | | | | |   +-----|----Y------------------+   |         | |   |   |         | | | |   |           |   +-------------+         | | | |         | |   | +-|-+   |     | |     |     | |       |
            | | | | |         | |               | |   |   |         | |   |   |         | | | |   |           |       |       | |         | | | |         | |   | | |     |     | |     |     | |       |
            | | | | |         | |               +-|---|-------------|---+ |   |         | | | |   |           |       |       | +---------|-----------------|-----+ |     |     | |     |     | |       |
            | | | | |         | |                 |   |   |         | | | |   |         | | | |   |           |       |       |           | | | |         | |   |   |     |     | |     |     | |       |
            | | | | |         | |     +-----------|---|-----------------|-|-------------|-|-|-|---|-----------|-------|-------+           | | | |         | |   |   |     |     | |     |     | |       |
            | | | | |         | |     |           |   |   |         | | | |   |         | | | |   |           |       |                   | | | |         | |   |   |     |     | |     |     | |       |
            | | | | |         | |     |           |   |   |         | +---|---|-------------------|-----------|-------|-------------------|-|---|-----------|-------|-------------------|-------|-------|-+
            | | | | |         | |     |           |   |   |         |   | |   |         | | | |   |           |       |                   | | | |         | |   |   |     |     | |     |     | |       | |
            | | | +-------------------+           |   |   |         |   | |   |         | | | |   |           |       |                   | | | |         | |   |   |     |     | |     |     | |       | |
            | | |   |         | |                 |   |   |         |   | |   |         | | | |   |           |       |                   | | | |         | |   |   |     |     | |     |     | |       | |
            | | |   |   +-------|-----+           |   |   |         +---|-----------------|-|-----+           |       +-+                 | | | |         | |   |   |     |     | |     +---+ | |       | |
            | | |   |   |     | |     |           |   |   |             | |   |         | | | |               |         |                 | | | |         | |   |   |     |     | |         | | |       | |
            | +-|---|-------------------------------------+             | |   |         | | | |               |         +-------------------|---|-----------|---|---|-----|-------|-----------|-|-------+ |
            |   |   |   |     | |     |           |   |                 | |   |         | | | |               |                           | | | |         | |   |   |     |     | |         | | |         |
        +---|-----+ |   |     | |     |           |   |                 | |   |         | | | |               |                           +-|-------------|-|---|---+     +-----+ |         | | |         |
        |   |   | | |   |     | |     |           |   |                 | |   |         | | | |               |                             | | |         | |   |                 |         | | |         |
        |   |   | | |   |     | |     |           |   |                 | |   |         | | | | +-------------|---------+                   | | |         | |   |                 |         | | |         |
        |   |   | | |   |     | |     |           |   |                 | |   |         | | | | |             |         |                   | | |         | |   |                 |         | | |         |
        |   |   | | |   |     | |   +-----------------|-------------------+   |         | | | | |             |         +-------------------|-------------|-|---------------------|---------+ | |         |
        |   |   | | |   |     | |   | |           |   |                 |     |         | | | | |             |                             | | |         | |   |                 |           | |         |
        |   |   | | |   |     | |   | |           +---|-----------------|-----|-----------|-|-|-+             |                             | | |         | |   |                 |           | |         |
        |   |   | | |   |     | |   | |               |                 |     |         | | | |               |                             | | |         | |   |                 |           | |         |
        |   |   | | |   |     | |   | |               |                 |     |         +---------------------------------------------------+ | |         | | +-|-----------------|-----------|-|---------+
        |   |   | | |   |     | |   | |               |                 |     |           | | |               |                               | |         | | | |                 |           | |
        |   |   | | |   |     | |   | |               |                 |     |           | | |           +---|-------------------------------|-|---------|-|---------------------+           | |   +-+
        |   |   | | |   |     | |   | |               |                 |     |           | | |           |   |                               | |         | | | |                             | |   | |
    +---|---|-------+   |     | |   | +---------------------------------|-----|-----------+ | |           |   |                               +-----------|-|---------------------------------|-+   | |
    |   |   |   | |     |     | |   |                 |                 |     |             | |           |   |                                 |         | | | |                             |     | |
    |   |   |   +-+     |     +-|---|-----------------|-----------------------------------------------------------------------------------------------------|---|-----------------------------+     | |
    |   |   |           |       |   |                 |                 |     |             | |           |   |                                 |         | | | |                                   | |
    +---+   |           |       |   |                 |                 +-------------------|-----------------|-------------------------------------------|---+ +-------------------------------------+
            |           |       |   |                 |                       |             | |           |   |                                 |         | |                                       |
    +---+   |   +-------|-------|---|-+               |                       |             | +---------------|---------------------------------|---------|-|-----------------------------------+   |
    |   |   |   |       |       |   | |               |                       |             |             |   |                                 |         | |                                   |   |
    +---|---------------|-------|---|-----------------|-----------------------|-------------|-------------|---|---------------------------------|---------+ |                                   |   |
        |   |   |       |       |   | |               |                       |             |             |   |                                 |           |                                   |   |
        |   |   |       |       |   +-----+           |                       |             |             +---|-+                               +-----------+                                   |   |
        |   |   |       |       |     |   |           |                       |             |                 | |                                                                               |   |
        +---|---+       +-------+     +---+           |                       +-------------|-----------------+ +---------------------------------------------------+                           +---+
            |                                         |                                     |                                                                       |
            +-----------------------------------------+                                     +-----------------------------------------------------------------------+

   """
